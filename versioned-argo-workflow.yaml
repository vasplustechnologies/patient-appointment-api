apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: versioned-ci-
spec:
  entrypoint: main
  templates:
  - name: main
    steps:
    - - name: clone-and-test
        template: clone-test-build
    - - name: build-and-push
        template: kaniko-build
        arguments:
          parameters:
          - name: commit-sha
            value: "{{steps.clone-and-test.outputs.parameters.commit-sha}}"
        
  - name: clone-test-build
    container:
      image: node:18-alpine
      workingDir: /workspace
      command: [sh, -c]
      args:
      - |
        echo "ğŸš€ STARTING VERSIONED CI PIPELINE..."
        
        # Clone repository
        echo "ğŸ“¦ Cloning repository..."
        apk add --no-cache git
        git clone https://github.com/vasplustechnologies/patient-appointment-api-v2.git /workspace
        
        cd /workspace
        echo "ğŸ“ Current commit:"
        git log --oneline -1
        
        # Get short commit SHA for versioning
        COMMIT_SHA=$(git rev-parse --short HEAD)
        echo "ğŸ”– Commit SHA: $COMMIT_SHA"
        
        # Output the commit SHA as a parameter
        echo $COMMIT_SHA > /tmp/commit-sha.txt
        
        echo "ğŸ§ª Installing dependencies..."
        npm install
        
        echo "ğŸ”¬ Running tests..."
        npx jest --verbose || echo "âš ï¸ Tests completed with warnings"
        
        echo "âœ… Ready for versioned build!"
    outputs:
      parameters:
      - name: commit-sha
        valueFrom:
          path: /tmp/commit-sha.txt
        
  - name: kaniko-build
    inputs:
      parameters:
      - name: commit-sha
    container:
      image: gcr.io/kaniko-project/executor:latest
      args:
      - --context=git://github.com/vasplustechnologies/patient-appointment-api-v2.git
      - --destination=mofwili/patient-appointment-api:latest
      - --destination=mofwili/patient-appointment-api:{{inputs.parameters.commit-sha}}
      - --cache=true
      - --verbosity=info
      env:
      - name: DOCKER_CONFIG
        value: /kaniko/.docker
      volumeMounts:
      - name: kaniko-secret
        mountPath: /kaniko/.docker
    volumes:
    - name: kaniko-secret
      secret:
        secretName: dockerhub-credentials
        items:
        - key: .dockerconfigjson
          path: config.json