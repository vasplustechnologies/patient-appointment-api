apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: versioned-ci-
spec:
  entrypoint: main
  templates:
  - name: main
    steps:
    - - name: get-next-version
        template: get-next-version
    - - name: clone-and-test
        template: clone-test-build
        arguments:
          parameters:
          - name: image-version
            value: "{{steps.get-next-version.outputs.parameters.next-version}}"
    - - name: build-and-push
        template: kaniko-build
        arguments:
          parameters:
          - name: image-version
            value: "{{steps.get-next-version.outputs.parameters.next-version}}"

  - name: get-next-version
    container:
      image: bitnami/kubectl:latest
      command: [sh, -c]
      args:
        - |
          # Get current version from ConfigMap
          CURRENT_VERSION=$(kubectl get configmap version-counter -o jsonpath='{.data.current-version}')
          echo "🏷️ Current version: v$CURRENT_VERSION"
          
          # Increment version
          NEXT_VERSION=$((CURRENT_VERSION + 1))
          echo "🆕 Next version: v$NEXT_VERSION"
          
          # Update ConfigMap
          kubectl patch configmap version-counter --type='json' -p='[{"op": "replace", "path": "/data/current-version", "value":"'"$NEXT_VERSION"'"}]'
          
          # Output the version
          echo "v$NEXT_VERSION" > /tmp/next-version.txt
    outputs:
      parameters:
      - name: next-version
        valueFrom:
          path: /tmp/next-version.txt

  - name: clone-test-build
    inputs:
      parameters:
      - name: image-version
    container:
      image: node:18-alpine
      workingDir: /workspace
      command: [sh, -c]
      args:
        - |
          echo "🚀 STARTING CI PIPELINE - Version: {{inputs.parameters.image-version}}"
          
          # Clone repository
          echo "📦 Cloning repository..."
          apk add --no-cache git
          git clone https://github.com/vasplustechnologies/patient-appointment-api-v2.git /workspace
          
          echo "📁 Checking files..."
          ls -la
          
          echo "🧪 Installing dependencies..."
          npm install
          
          echo "🔬 Running tests..."
          npm test || echo "⚠️ Tests completed with warnings"
          
          echo "✅ Tests completed for version: {{inputs.parameters.image-version}}"

  - name: kaniko-build
    inputs:
      parameters:
      - name: image-version
    container:
      image: gcr.io/kaniko-project/executor:latest
      args:
      - --context=git://github.com/vasplustechnologies/patient-appointment-api-v2.git
      - --destination=mofwili/patient-appointment-api:latest
      - --destination=mofwili/patient-appointment-api:{{inputs.parameters.image-version}}
      - --cache=true
      - --verbosity=info
      env:
      - name: DOCKER_CONFIG
        value: /kaniko/.docker
      volumeMounts:
      - name: kaniko-secret
        mountPath: /kaniko/.docker
    volumes:
    - name: kaniko-secret
      secret:
        secretName: dockerhub-credentials
        items:
        - key: .dockerconfigjson
          path: config.json